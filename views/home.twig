<!doctype html public "-//w3c//dtd html 4.0 strict//en">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<title>reddit-stream</title>

<link rel="stylesheet" href="{{root}}/content/css/default.css" type="text/css">
<link rel="stylesheet" href="{{root}}/content/css/base.css" type="text/css">

<script src='{{root}}/content/js/mootools-1.3.2-core.js' type='text/javascript'></script>
<script src='{{root}}/content/js/mootools-1.4.0.1-more.js' type='text/javascript'></script>
<script src='{{root}}/content/js/rs-lib.js' type='text/javascript'></script>

<script type='text/javascript'>
_thread_id = '{{thread_id}}';
</script>

<script type='text/javascript'>

var Ui = {
	init: function() {
		this.first_load = true;
		this.last_id = null;
		this.refresh();

		this.refresh.periodical(10000, this);
	},

	refresh: function() {
		var request_url = 'http://www.reddit.com/comments/' + _thread_id + '.json?sort=new&limit=50'

		new Request.JSONP({
			'url':request_url,
			'callbackKey':'jsonp',
			'onComplete': function(data){
				var post_info = data[0].data.children[0];
				var comments = data[1].data.children.reverse();
				var start_index = this.new_comment(comments, this.last_id);
				var was_bottom = this.is_at_bottom();

				if(this.first_load) {
					this.set_post_info(post_info);
					this.first_load = false;
				}

				this.add_comments(comments, start_index);
				this.last_id = comments.getLast().data.id;

				if(was_bottom) {
					window.scrollTo(0, document.body.scrollHeight);
				}

			}.bind(this)
		}).send();
	},

	is_at_bottom: function() {
		var totalHeight, currentScroll, visibleHeight;

		if (document.documentElement.scrollTop) {
			currentScroll = document.documentElement.scrollTop;
		} else {
			currentScroll = document.body.scrollTop;
		}

		totalHeight = document.body.offsetHeight;
		visibleHeight = document.documentElement.clientHeight;

		return totalHeight <= (currentScroll + visibleHeight);
	},

	// returns the array index of the first new comment.
	//
	// if none are new it will return comments.length.
	// if all a new it will return 0
	new_comment: function(comments, last_id) {
		var start_index = 0;

		// loop through the list of comments to find the most recent one from last time.
		// Everything after that is new. If we don't find the id, then everything is new
		for(var i=0; i < comments.length; i++) {
			if(comments[i].data.id == this.last_id) {
				start_index = i + 1;
				break;
			}
		}

		return start_index;
	},

	set_post_info: function(post_info) {
		$e('a', {
			'text':post_info.data.title,
			'href':post_info.data.url
		}).inject('post-title');
	},

	add_comments: function(comments, start_index) {
		for(var i=start_index; i < comments.length; i++) {
			var item = comments[i];
			if(!$defined(item.data.body)) {
				continue;
			}

			$e('div.comment', {
				'children': [
					$e('div', {'class': 'c-username', 'text':item.data.author}),
					$e('div', {'class': 'c-body', 'html': item.data.body_html.decodeEntities()})
				]

			}).inject('c-list');
		}
	},

	all_info: function() {
		$('sidebar').addClass('expanded');
	}
}

window.addEvent('load', Ui.init.bind(Ui));

</script>


</head>

<body>

<div id='c-list' class='left'></div>

<div id='sidebar' class='left'>
	<div id='post-title'></div>
</div>

<div class='clear'></div>

</body>
</html>
